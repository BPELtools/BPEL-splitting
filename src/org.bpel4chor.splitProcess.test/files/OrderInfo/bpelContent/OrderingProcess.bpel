<bpel:process name="OrderingProcess" targetNamespace="http://www.iaas.uni-stuttgart.de"
			  suppressJoinFailure="yes" xmlns:tns="http://www.iaas.uni-stuttgart.de"
			  xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
			  xmlns:plts="http://www.iaas.uni-stuttgart.de/OrderingProcess/partnerLinkTypes"
			  xmlns:po="http://www.bpel4chor.org/splitProcess/test/services/ProcessOrder"
			  xmlns:pp="http://www.bpel4chor.org/splitProcess/test/services/ProcessPayment"
			  exitOnStandardFault="no" xmlns:xsd="http://www.w3.org/2001/XMLSchema">

	<!-- Import the client WSDL -->
	<bpel:import namespace="http://www.iaas.uni-stuttgart.de/OrderingProcess/partnerLinkTypes"
				 location="partnerLinks.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
	<bpel:import namespace="http://www.bpel4chor.org/splitProcess/test/services/ProcessPayment"
				 location="ProcessPayment.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
	<bpel:import namespace="http://www.bpel4chor.org/splitProcess/test/services/ProcessOrder"
				 location="ProcessOrder.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
	<bpel:import namespace="http://www.iaas.uni-stuttgart.de"
				 location="OrderingProcess.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>

	<!-- ================================================================= -->
	<!-- ORCHESTRATION LOGIC -->
	<!-- Set of activities coordinating the flow of messages across the -->
	<!-- services integrated within this business process -->
	<!-- ================================================================= -->

	<bpel:partnerLinks xmlns:plt="http://www.iaas.uni-stuttgart.de/OrderingProcess/partnerLinkTypes">
		<bpel:partnerLink name="orderingPL" partnerLinkType="tns:OrderingProcessPT"
						  myRole="OrderProcessProvider"/>
		<bpel:partnerLink name="processOrderPL"
						  partnerLinkType="plts:ProcessOrderPLT" partnerRole="ProcessOrder"/>
		<bpel:partnerLink name="processPaymentPL"
						  partnerLinkType="plts:ProcessPaymentPLT" partnerRole="ProcessPayment"/>
	</bpel:partnerLinks>
	<bpel:variables>
		<bpel:variable name="order" messageType="tns:orderRequest"/>

		<bpel:variable name="response" messageType="tns:orderResponse"/>

		<bpel:variable name="paymentInfo" messageType="tns:processPayment"/>

		<bpel:variable name="processOrderPLRequest" messageType="tns:processOrder"/>
	</bpel:variables>
	<bpel:correlationSets>
		<bpel:correlationSet name="CorrelationSet"
							 properties="tns:correlProperty"/>
	</bpel:correlationSets>
	<bpel:flow name="Flow">
		<bpel:links>
			<bpel:link name="ReceiveA2AssignB"/>
			<bpel:link name="AssignB2C"/>
			<bpel:link name="AssignB2E"/>
			<bpel:link name="AssignB2D"/>
			<bpel:link name="AssignC2E"/>
			<bpel:link name="AssignD2E"/>
			<bpel:link name="AssignE2InvokeF"/>
			<bpel:link name="InvokeF2G"/>
			<bpel:link name="InvokeF2ReplyH"/>
		</bpel:links>
		<bpel:receive name="A" createInstance="yes"
					  partnerLink="orderingPL" operation="order" portType="tns:OrderingProcess"
					  variable="order">
			<bpel:sources>
				<bpel:source linkName="ReceiveA2AssignB"/>
			</bpel:sources>
		</bpel:receive>
		<bpel:assign validate="no" name="B">
			<bpel:targets>
				<bpel:target linkName="ReceiveA2AssignB"/>
			</bpel:targets>
			<bpel:sources>
				<bpel:source linkName="AssignB2C">
					<bpel:transitionCondition><![CDATA[$order.info/status="gold"]]></bpel:transitionCondition>
				</bpel:source>
				<bpel:source linkName="AssignB2D">
					<bpel:transitionCondition><![CDATA[$order.info/status="silver"]]></bpel:transitionCondition>
				</bpel:source>
				<bpel:source linkName="AssignB2E"/>
			</bpel:sources>
			<bpel:copy>
				<bpel:from>$order.info/accountNumber</bpel:from>
				<bpel:to>$paymentInfo.payload/actNum</bpel:to>
			</bpel:copy>
			<bpel:copy>
				<bpel:from><![CDATA[string("Dear customer,...")]]></bpel:from>
				<bpel:to part="text" variable="response" />
			</bpel:copy>
			<bpel:copy>
				<bpel:from><![CDATA[$order.info/orderTotalPrice + 5*$order.info/numDeliveries]]></bpel:from>
				<bpel:to>$paymentInfo.payload/amt</bpel:to>
			</bpel:copy>
		</bpel:assign>
		<bpel:assign validate="no" name="C">
			<bpel:targets>
				<bpel:target linkName="AssignB2C"/>
			</bpel:targets>
			<bpel:sources>
				<bpel:source linkName="AssignC2E"/>
			</bpel:sources>
			<bpel:copy>
				<bpel:from><![CDATA[concat($response.text, "10% discount")]]></bpel:from>
				<bpel:to part="text" variable="response" />
			</bpel:copy>
			<bpel:copy>
				<bpel:from><![CDATA[$paymentInfo.amt*0.9]]></bpel:from>
				<bpel:to>$paymentInfo.payload/amt</bpel:to>
			</bpel:copy>
		</bpel:assign>
		<bpel:assign validate="no" name="D">
			<bpel:targets>
				<bpel:target linkName="AssignB2D"/>
			</bpel:targets>
			<bpel:sources>
				<bpel:source linkName="AssignD2E"/>
			</bpel:sources>
			<bpel:copy>
				<bpel:from>
					<![CDATA[concat($response.text, " 5% discount")]]>
				</bpel:from>
				<bpel:to part="text" variable="response">
				</bpel:to>
			</bpel:copy>
			<bpel:copy>
				<bpel:from>
					<![CDATA[$paymentInfo.amt*0.95]]>
				</bpel:from>
				<bpel:to part="amt" variable="paymentInfo">
				</bpel:to>
			</bpel:copy>
		</bpel:assign>
		<bpel:assign validate="no" name="E">
			<bpel:targets>
				<bpel:target linkName="AssignB2E"/>
				<bpel:target linkName="AssignC2E"/>
				<bpel:target linkName="AssignD2E"/>
			</bpel:targets>
			<bpel:sources>
				<bpel:source linkName="AssignE2InvokeF"/>
			</bpel:sources>
			<bpel:copy>
				<bpel:from>price calculated</bpel:from>
				<bpel:to part="text" variable="response" />
			</bpel:copy>
		</bpel:assign>
		<bpel:invoke name="F" partnerLink="processOrderPL"
					 operation="processOrder" portType="tns:ProcessOrder" inputVariable="processOrderPLRequest">
			<bpel:targets>
				<bpel:target linkName="AssignE2InvokeF"/>
			</bpel:targets>
			<bpel:sources>
				<bpel:source linkName="InvokeF2G"/>
				<bpel:source linkName="InvokeF2ReplyH"/>
			</bpel:sources>
		</bpel:invoke>
		<bpel:invoke name="G" partnerLink="processPaymentPL" operation="processPayment" portType="tns:ProcessPayment"
					 inputVariable="paymentInfo">
			<bpel:targets>
				<bpel:target linkName="InvokeF2G"/>
			</bpel:targets>
		</bpel:invoke>
		<bpel:reply name="H" partnerLink="orderingPL"
					operation="order" portType="tns:OrderingProcess" variable="response">
			<bpel:targets>
				<bpel:target linkName="InvokeF2ReplyH"/>
			</bpel:targets>
		</bpel:reply>
	</bpel:flow>
</bpel:process>

